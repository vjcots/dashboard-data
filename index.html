<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Usuarios en asistencia</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f5fa; --text:#0f0f0f; --blue:#0045e6;
      --card:#fff;  --border:#e2e2e9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);padding:2rem;}
    h1{font-size:2rem;font-weight:700;margin-bottom:2rem;}
    .user-list{display:grid;gap:1rem;}
    .user-card{
      background:var(--card);border:1px solid var(--border);border-radius:12px;
      padding:1rem 1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.05);
      transition:transform .15s ease,border-color .15s ease;
    }
    .user-card:hover{transform:translateY(-2px);border-color:var(--blue);}
    .user-link{color:var(--blue);text-decoration:none;font-size:1.05rem;font-weight:500;}
  </style>
  <script src="utils.js"></script>
</head>
<body>

<h1>Usuarios en asistencia</h1>
<div id="lista" class="user-list"></div>

<script>
  // ------------- estado de lo que ya está pintado -------------
  const rendered = new Map(); // telefono -> texto mostrado

  // ------------- crea tarjeta -------------
  function crearTarjeta(tel, texto){
    const card = document.createElement('div');
    card.id = `u-${tel}`;
    card.className = 'user-card';
    const link = document.createElement('a');
    link.href = `usuario.html?telefono=${tel}`;
    link.className = 'user-link';
    link.textContent = texto;
    card.appendChild(link);
    return card;
  }

  // ------------- bucle de refresco -------------
  async function refrescar(){
    // 1. obtener claves y datos
    const keys = await redisKeys('user:*:meta');
    const nuevos = new Map();

    await Promise.all(keys.map(async k=>{
      const d = await redisHGetAll(k);
      const telRaw = d.telefono || k.split(':')[1];
      const tel    = telRaw.replace('+34','');
      const nombre = d.profileName || d.nombre || 'Sin nombre';
      const imei   = d.imei || 'Sin IMEI';
      const texto  = `${tel} - ${nombre} - ${imei}`;
      nuevos.set(tel, texto);
    }));

    const lista = document.getElementById('lista');

    // 2. añadir o actualizar
    nuevos.forEach((texto,tel)=>{
      if(!rendered.has(tel)){
        // nuevo -> añadir
        lista.appendChild(crearTarjeta(tel, texto));
      }else if(rendered.get(tel)!==texto){
        // cambiado -> actualizar texto
        document.querySelector(`#u-${tel} .user-link`).textContent = texto;
      }
    });

    // 3. eliminar los que ya no existen
    rendered.forEach((_,tel)=>{
      if(!nuevos.has(tel)){
        const el = document.getElementById(`u-${tel}`);
        if(el) el.remove();
      }
    });

    // 4. guardar snapshot actual
    rendered.clear();
    nuevos.forEach((txt,tel)=>rendered.set(tel,txt));
  }

  // primera carga + polling
  refrescar();
  setInterval(refrescar, 5000);
</script>
</body>
</html>
